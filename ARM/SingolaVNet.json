{
  "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.14.85.62628",
      "templateHash": "13405157972346793994"
    }
  },
  "parameters": {
    "Seed": {
      "type": "string"
    },
    "MyIP": {
      "type": "string"
    },
    "Location": {
      "type": "string",
      "defaultValue": "westeurope"
    },
    "adminPassword": {
      "type": "secureString"
    },
    "MyObjectId": {
      "type": "string"
    },
    "SpokesNumber": {
      "type": "int",
      "defaultValue": 0
    },
    "HubRgPostfix": {
      "type": "string",
      "defaultValue": "Hub"
    },
    "HubVnetPrefix": {
      "type": "string",
      "defaultValue": "Hub-VNet"
    },
    "InSubnetPrefix": {
      "type": "string",
      "defaultValue": "dns-inbound"
    },
    "OutSubnetPrefix": {
      "type": "string",
      "defaultValue": "dns-outbound"
    },
    "PEsubnetName": {
      "type": "string",
      "defaultValue": "PE-subnet"
    },
    "HubVnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.10.0.0/16"
    },
    "CustomDNSserver": {
      "type": "string",
      "defaultValue": "10.10.100.4"
    },
    "DNSInboundSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.10.100.0/28"
    },
    "DNSOutboundSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.10.100.16/28"
    },
    "BastionSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.10.0.64/26"
    },
    "PEsubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.10.1.0/24"
    },
    "FirewallSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.10.2.0/24"
    },
    "GatewaySubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "10.10.3.0/24"
    },
    "DeployNSG": {
      "type": "bool",
      "defaultValue": true
    },
    "DeployRT": {
      "type": "bool",
      "defaultValue": true
    },
    "DeployBS": {
      "type": "bool",
      "defaultValue": false
    },
    "DeployDNS": {
      "type": "bool",
      "defaultValue": false
    },
    "DeployKV": {
      "type": "bool",
      "defaultValue": false
    },
    "SpokeRgPostfix": {
      "type": "string",
      "defaultValue": "Spokes"
    },
    "DeployOnPrem": {
      "type": "bool",
      "defaultValue": false
    },
    "DeployProxy": {
      "type": "bool",
      "defaultValue": false
    },
    "OnPremRgPostfix": {
      "type": "string",
      "defaultValue": "OnPrem"
    },
    "OnPremVnetPrefix": {
      "type": "string",
      "defaultValue": "OnPrem-VLan"
    },
    "OnPremVnetAddressPrefix": {
      "type": "string",
      "defaultValue": "192.168.0.0/16"
    },
    "OnPremGWvnetSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "192.168.0.0/26"
    },
    "OnPremPEvnetSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "192.168.1.0/24"
    },
    "OnPremDMZvnetSubnetAddressPrefix": {
      "type": "string",
      "defaultValue": "192.168.2.0/24"
    }
  },
  "variables": {
    "HubRgName": "[format('{0}-{1}', parameters('Seed'), parameters('HubRgPostfix'))]",
    "HubVnetName": "[format('{0}-{1}', parameters('HubVnetPrefix'), parameters('Seed'))]",
    "InSubnetName": "[format('{0}-{1}', parameters('InSubnetPrefix'), parameters('Seed'))]",
    "OutSubnetName": "[format('{0}-{1}', parameters('OutSubnetPrefix'), parameters('Seed'))]",
    "NSGname": "[format('NSG-{0}', parameters('Seed'))]",
    "RouteTabelName": "[format('RT-{0}', parameters('Seed'))]",
    "SpokeRgName": "[format('{0}-{1}', parameters('Seed'), parameters('SpokeRgPostfix'))]",
    "OnPremRGname": "[format('{0}-{1}', parameters('Seed'), parameters('OnPremRgPostfix'))]",
    "OnPremVnetName": "[format('{0}-{1}', parameters('OnPremVnetPrefix'), parameters('Seed'))]",
    "ProxyName": "[format('Proxy-{0}', parameters('Seed'))]"
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-01-01",
      "name": "[variables('HubRgName')]",
      "location": "[parameters('Location')]"
    },
    {
      "condition": "[greater(parameters('SpokesNumber'), 0)]",
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-01-01",
      "name": "[variables('SpokeRgName')]",
      "location": "[parameters('Location')]"
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('HubEssentialDeploy-{0}', parameters('Seed'))]",
      "resourceGroup": "[variables('HubRgName')]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "HubVnetName": {
            "value": "[variables('HubVnetName')]"
          },
          "HubVnetAddressPrefix": {
            "value": "[parameters('HubVnetAddressPrefix')]"
          },
          "PEsubnetName": {
            "value": "[parameters('PEsubnetName')]"
          },
          "PEsubnetAddressPrefix": {
            "value": "[parameters('PEsubnetAddressPrefix')]"
          },
          "BastionSubnetAddressPrefix": {
            "value": "[parameters('BastionSubnetAddressPrefix')]"
          },
          "DNSInboundSubnetAddressPrefix": {
            "value": "[parameters('DNSInboundSubnetAddressPrefix')]"
          },
          "DNSOutboundSubnetAddressPrefix": {
            "value": "[parameters('DNSOutboundSubnetAddressPrefix')]"
          },
          "FirewallSubnetAddressPrefix": {
            "value": "[parameters('FirewallSubnetAddressPrefix')]"
          },
          "GatewaySubnetAddressPrefix": {
            "value": "[parameters('GatewaySubnetAddressPrefix')]"
          },
          "InSubnetName": {
            "value": "[variables('InSubnetName')]"
          },
          "OutSubnetName": {
            "value": "[variables('OutSubnetName')]"
          },
          "NSGname": {
            "value": "[variables('NSGname')]"
          },
          "RouteTableName": {
            "value": "[variables('RouteTabelName')]"
          },
          "MyIPaddress": {
            "value": "[parameters('MyIP')]"
          },
          "MyObjectId": {
            "value": "[parameters('MyObjectId')]"
          },
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "location": {
            "value": "[parameters('Location')]"
          },
          "Seed": {
            "value": "[parameters('Seed')]"
          },
          "DeployBS": {
            "value": "[parameters('DeployBS')]"
          },
          "DeployDNS": {
            "value": "[parameters('DeployDNS')]"
          },
          "DeployNSG": {
            "value": "[parameters('DeployNSG')]"
          },
          "DeployRT": {
            "value": "[parameters('DeployRT')]"
          },
          "DeployKV": {
            "value": "[parameters('DeployKV')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.14.85.62628",
              "templateHash": "3393311383233583767"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "defaultValue": "[resourceGroup().location]"
            },
            "Seed": {
              "type": "string"
            },
            "MyObjectId": {
              "type": "string"
            },
            "adminPassword": {
              "type": "securestring"
            },
            "CustomDNSserver": {
              "type": "string",
              "defaultValue": "10.10.0.4"
            },
            "NSGname": {
              "type": "string"
            },
            "RouteTableName": {
              "type": "string"
            },
            "disableBgpRoutePropagation": {
              "type": "bool",
              "defaultValue": false
            },
            "MyIPaddress": {
              "type": "string"
            },
            "HubVnetName": {
              "type": "string"
            },
            "HubVnetAddressPrefix": {
              "type": "string"
            },
            "InSubnetName": {
              "type": "string"
            },
            "OutSubnetName": {
              "type": "string"
            },
            "PEsubnetName": {
              "type": "string"
            },
            "DNSInboundSubnetAddressPrefix": {
              "type": "string"
            },
            "DNSOutboundSubnetAddressPrefix": {
              "type": "string"
            },
            "BastionSubnetAddressPrefix": {
              "type": "string"
            },
            "PEsubnetAddressPrefix": {
              "type": "string"
            },
            "FirewallSubnetAddressPrefix": {
              "type": "string"
            },
            "GatewaySubnetAddressPrefix": {
              "type": "string"
            },
            "DeployNSG": {
              "type": "bool"
            },
            "DeployRT": {
              "type": "bool"
            },
            "DeployBS": {
              "type": "bool"
            },
            "DeployDNS": {
              "type": "bool"
            },
            "DeployKV": {
              "type": "bool"
            }
          },
          "variables": {
            "FwName": "[format('AzFW-{0}', parameters('Seed'))]",
            "publicIpName": "[format('pip-bastion-{0}', parameters('Seed'))]",
            "bastionHostName": "[format('bastion-jumpbox-{0}', parameters('Seed'))]",
            "ResolverName": "[format('DNS-{0}', parameters('Seed'))]",
            "RulesetName": "[format('RS-{0}', parameters('Seed'))]",
            "NetworkLinkName": "[format('{0}-link', parameters('HubVnetName'))]",
            "KVname": "[format('KV-{0}', parameters('Seed'))]"
          },
          "resources": [
            {
              "condition": "[parameters('DeployNSG')]",
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2021-02-01",
              "name": "[parameters('NSGname')]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": []
              }
            },
            {
              "condition": "[parameters('DeployBS')]",
              "type": "Microsoft.Network/networkSecurityGroups",
              "apiVersion": "2021-02-01",
              "name": "[format('Bastion-{0}', parameters('NSGname'))]",
              "location": "[parameters('location')]",
              "properties": {
                "securityRules": [
                  {
                    "name": "AllowAzureCloudOutbound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "AzureCloud",
                      "access": "Allow",
                      "priority": 200,
                      "direction": "Outbound",
                      "sourcePortRanges": [],
                      "destinationPortRanges": [],
                      "sourceAddressPrefixes": [],
                      "destinationAddressPrefixes": []
                    }
                  },
                  {
                    "name": "AllowGatewayManagerInbound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "GatewayManager",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 300,
                      "direction": "Inbound",
                      "sourcePortRanges": [],
                      "destinationPortRanges": [],
                      "sourceAddressPrefixes": [],
                      "destinationAddressPrefixes": []
                    }
                  },
                  {
                    "name": "AllowHttpsInbound",
                    "properties": {
                      "protocol": "Tcp",
                      "sourcePortRange": "*",
                      "destinationPortRange": "443",
                      "sourceAddressPrefix": "[parameters('MyIPaddress')]",
                      "destinationAddressPrefix": "*",
                      "access": "Allow",
                      "priority": 200,
                      "direction": "Inbound",
                      "sourcePortRanges": [],
                      "destinationPortRanges": [],
                      "sourceAddressPrefixes": [],
                      "destinationAddressPrefixes": []
                    }
                  },
                  {
                    "name": "AllowSshRdpOutbound",
                    "properties": {
                      "protocol": "*",
                      "sourcePortRange": "*",
                      "sourceAddressPrefix": "*",
                      "destinationAddressPrefix": "VirtualNetwork",
                      "access": "Allow",
                      "priority": 100,
                      "direction": "Outbound",
                      "sourcePortRanges": [],
                      "destinationPortRanges": [
                        "22",
                        "3389"
                      ],
                      "sourceAddressPrefixes": [],
                      "destinationAddressPrefixes": []
                    }
                  }
                ]
              }
            },
            {
              "condition": "[parameters('DeployRT')]",
              "type": "Microsoft.Network/routeTables",
              "apiVersion": "2021-08-01",
              "name": "[parameters('RouteTableName')]",
              "location": "[parameters('location')]",
              "properties": {
                "disableBgpRoutePropagation": "[parameters('disableBgpRoutePropagation')]",
                "routes": []
              }
            },
            {
              "condition": "[parameters('DeployRT')]",
              "type": "Microsoft.Network/routeTables/routes",
              "apiVersion": "2021-08-01",
              "name": "[format('{0}/ToFW', parameters('RouteTableName'))]",
              "properties": {
                "addressPrefix": "0.0.0.0/0",
                "nextHopType": "VirtualAppliance",
                "nextHopIpAddress": "[if(parameters('DeployRT'), reference(resourceId('Microsoft.Resources/deployments', variables('FwName')), '2020-10-01').outputs.FwIP.value, '')]",
                "hasBgpOverride": false
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', variables('FwName'))]",
                "[resourceId('Microsoft.Network/routeTables', parameters('RouteTableName'))]"
              ]
            },
            {
              "type": "Microsoft.Network/virtualNetworks",
              "apiVersion": "2021-02-01",
              "name": "[parameters('HubVnetName')]",
              "location": "[parameters('location')]",
              "properties": {
                "addressSpace": {
                  "addressPrefixes": [
                    "[parameters('HubVnetAddressPrefix')]"
                  ]
                },
                "dhcpOptions": {
                  "dnsServers": "[if(parameters('DeployDNS'), createArray(parameters('CustomDNSserver')), null())]"
                },
                "subnets": [
                  {
                    "name": "[parameters('InSubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('DNSInboundSubnetAddressPrefix')]",
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled",
                      "delegations": [
                        {
                          "name": "Microsoft.Network.dnsResolvers",
                          "properties": {
                            "serviceName": "Microsoft.Network/dnsResolvers"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "name": "[parameters('OutSubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('DNSOutboundSubnetAddressPrefix')]",
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled",
                      "delegations": [
                        {
                          "name": "Microsoft.Network.dnsResolvers",
                          "properties": {
                            "serviceName": "Microsoft.Network/dnsResolvers"
                          }
                        }
                      ]
                    }
                  },
                  {
                    "name": "AzureBastionSubnet",
                    "properties": {
                      "addressPrefix": "[parameters('BastionSubnetAddressPrefix')]",
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled",
                      "networkSecurityGroup": "[if(parameters('DeployBS'), createObject('id', resourceId('Microsoft.Network/networkSecurityGroups', format('Bastion-{0}', parameters('NSGname')))), null())]"
                    }
                  },
                  {
                    "name": "[parameters('PEsubnetName')]",
                    "properties": {
                      "addressPrefix": "[parameters('PEsubnetAddressPrefix')]",
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled",
                      "networkSecurityGroup": "[if(parameters('DeployNSG'), createObject('id', resourceId('Microsoft.Network/networkSecurityGroups', parameters('NSGname'))), null())]",
                      "routeTable": "[if(parameters('DeployRT'), createObject('id', resourceId('Microsoft.Network/routeTables', parameters('RouteTableName'))), null())]"
                    }
                  },
                  {
                    "name": "AzureFirewallSubnet",
                    "properties": {
                      "addressPrefix": "[parameters('FirewallSubnetAddressPrefix')]",
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  },
                  {
                    "name": "GatewaySubnet",
                    "properties": {
                      "addressPrefix": "[parameters('GatewaySubnetAddressPrefix')]",
                      "privateEndpointNetworkPolicies": "Disabled",
                      "privateLinkServiceNetworkPolicies": "Enabled"
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/networkSecurityGroups', format('Bastion-{0}', parameters('NSGname')))]",
                "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('NSGname'))]",
                "[resourceId('Microsoft.Network/routeTables', parameters('RouteTableName'))]"
              ]
            },
            {
              "condition": "[parameters('DeployRT')]",
              "type": "Microsoft.Network/networkSecurityGroups/securityRules",
              "apiVersion": "2021-08-01",
              "name": "[format('{0}/NoInternetHub', parameters('NSGname'))]",
              "properties": {
                "protocol": "Tcp",
                "sourcePortRange": "*",
                "sourceAddressPrefix": "*",
                "destinationAddressPrefix": "Internet",
                "access": "Deny",
                "priority": 1000,
                "direction": "Outbound",
                "sourcePortRanges": [],
                "destinationPortRanges": [
                  "443",
                  "80"
                ],
                "sourceAddressPrefixes": [],
                "destinationAddressPrefixes": []
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('HubVnetName'))]"
              ]
            },
            {
              "condition": "[parameters('DeployBS')]",
              "type": "Microsoft.Network/publicIPAddresses",
              "apiVersion": "2020-08-01",
              "name": "[variables('publicIpName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "publicIPAllocationMethod": "Static"
              }
            },
            {
              "condition": "[parameters('DeployBS')]",
              "type": "Microsoft.Network/bastionHosts",
              "apiVersion": "2022-01-01",
              "name": "[variables('bastionHostName')]",
              "location": "[parameters('location')]",
              "sku": {
                "name": "Standard"
              },
              "properties": {
                "enableIpConnect": true,
                "disableCopyPaste": false,
                "scaleUnits": 2,
                "enableTunneling": false,
                "ipConfigurations": [
                  {
                    "name": "IpConf",
                    "properties": {
                      "subnet": {
                        "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/AzureBastionSubnet', parameters('HubVnetName')), '/')[0], split(format('{0}/AzureBastionSubnet', parameters('HubVnetName')), '/')[1])]"
                      },
                      "publicIPAddress": {
                        "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
                      }
                    }
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('HubVnetName'))]",
                "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIpName'))]"
              ]
            },
            {
              "condition": "[or(parameters('DeployDNS'), parameters('DeployKV'))]",
              "type": "Microsoft.Network/dnsResolvers",
              "apiVersion": "2020-04-01-preview",
              "name": "[variables('ResolverName')]",
              "location": "[parameters('location')]",
              "properties": {
                "virtualNetwork": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('HubVnetName'))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('HubVnetName'))]"
              ]
            },
            {
              "condition": "[or(parameters('DeployDNS'), parameters('DeployKV'))]",
              "type": "Microsoft.Network/dnsResolvers/inboundEndpoints",
              "apiVersion": "2020-04-01-preview",
              "name": "[format('{0}/{1}', variables('ResolverName'), parameters('InSubnetName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "ipConfigurations": [
                  {
                    "subnet": {
                      "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', parameters('HubVnetName'), parameters('InSubnetName')), '/')[0], split(format('{0}/{1}', parameters('HubVnetName'), parameters('InSubnetName')), '/')[1])]"
                    },
                    "privateIpAllocationMethod": "Dynamic"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/dnsResolvers', variables('ResolverName'))]"
              ]
            },
            {
              "condition": "[or(parameters('DeployDNS'), parameters('DeployKV'))]",
              "type": "Microsoft.Network/dnsResolvers/outboundEndpoints",
              "apiVersion": "2020-04-01-preview",
              "name": "[format('{0}/{1}', variables('ResolverName'), parameters('OutSubnetName'))]",
              "location": "[parameters('location')]",
              "properties": {
                "subnet": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', split(format('{0}/{1}', parameters('HubVnetName'), parameters('OutSubnetName')), '/')[0], split(format('{0}/{1}', parameters('HubVnetName'), parameters('OutSubnetName')), '/')[1])]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/dnsResolvers/inboundEndpoints', split(format('{0}/{1}', variables('ResolverName'), parameters('InSubnetName')), '/')[0], split(format('{0}/{1}', variables('ResolverName'), parameters('InSubnetName')), '/')[1])]",
                "[resourceId('Microsoft.Network/dnsResolvers', variables('ResolverName'))]"
              ]
            },
            {
              "condition": "[or(parameters('DeployDNS'), parameters('DeployKV'))]",
              "type": "Microsoft.Network/dnsForwardingRulesets",
              "apiVersion": "2020-04-01-preview",
              "name": "[variables('RulesetName')]",
              "location": "[parameters('location')]",
              "properties": {
                "dnsResolverOutboundEndpoints": [
                  {
                    "id": "[resourceId('Microsoft.Network/dnsResolvers/outboundEndpoints', split(format('{0}/{1}', variables('ResolverName'), parameters('OutSubnetName')), '/')[0], split(format('{0}/{1}', variables('ResolverName'), parameters('OutSubnetName')), '/')[1])]"
                  }
                ]
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/dnsResolvers/inboundEndpoints', split(format('{0}/{1}', variables('ResolverName'), parameters('InSubnetName')), '/')[0], split(format('{0}/{1}', variables('ResolverName'), parameters('InSubnetName')), '/')[1])]",
                "[resourceId('Microsoft.Network/dnsResolvers/outboundEndpoints', split(format('{0}/{1}', variables('ResolverName'), parameters('OutSubnetName')), '/')[0], split(format('{0}/{1}', variables('ResolverName'), parameters('OutSubnetName')), '/')[1])]"
              ]
            },
            {
              "condition": "[or(parameters('DeployDNS'), parameters('DeployKV'))]",
              "type": "Microsoft.Network/dnsForwardingRulesets/virtualNetworkLinks",
              "apiVersion": "2020-04-01-preview",
              "name": "[format('{0}/{1}', variables('RulesetName'), variables('NetworkLinkName'))]",
              "properties": {
                "virtualNetwork": {
                  "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('HubVnetName'))]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('HubVnetName'))]",
                "[resourceId('Microsoft.Network/dnsForwardingRulesets', variables('RulesetName'))]"
              ]
            },
            {
              "condition": "[parameters('DeployKV')]",
              "type": "Microsoft.KeyVault/vaults/secrets",
              "apiVersion": "2021-04-01-preview",
              "name": "[format('{0}/adminPassword', variables('KVname'))]",
              "properties": {
                "value": "[parameters('adminPassword')]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.Resources/deployments', variables('KVname'))]",
                "[resourceId('Microsoft.Network/dnsForwardingRulesets', variables('RulesetName'))]"
              ]
            },
            {
              "condition": "[parameters('DeployRT')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('FwName')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "virtualNetworkName": {
                    "value": "[parameters('HubVnetName')]"
                  },
                  "Seed": {
                    "value": "[parameters('Seed')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "7096524277702050664"
                    }
                  },
                  "parameters": {
                    "virtualNetworkName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    },
                    "CustomDnsIp": {
                      "type": "string",
                      "defaultValue": "10.10.100.4"
                    },
                    "Seed": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "AzFwName": "[format('{0}-FW', parameters('Seed'))]",
                    "AzFwPolicyName": "[format('{0}-FWpolicy', parameters('Seed'))]",
                    "publiIPAddressName": "[format('{0}-IP', parameters('Seed'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2021-08-01",
                      "name": "[format('{0}/{1}', parameters('virtualNetworkName'), 'AzureFirewallSubnet')]",
                      "properties": {
                        "addressPrefix": "10.10.2.0/24"
                      }
                    },
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2021-08-01",
                      "name": "[variables('publiIPAddressName')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "Standard",
                        "tier": "Regional"
                      },
                      "zones": [],
                      "properties": {
                        "publicIPAllocationMethod": "Static"
                      }
                    },
                    {
                      "type": "Microsoft.Network/firewallPolicies",
                      "apiVersion": "2021-05-01",
                      "name": "[variables('AzFwPolicyName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "sku": {
                          "tier": "Premium"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Network/firewallPolicies/ruleCollectionGroups",
                      "apiVersion": "2021-08-01",
                      "name": "[format('{0}/{1}', variables('AzFwPolicyName'), 'DefaultApplicationRuleCollectionGroup')]",
                      "properties": {
                        "priority": 300,
                        "ruleCollections": [
                          {
                            "ruleCollectionType": "FirewallPolicyFilterRuleCollection",
                            "action": {
                              "type": "Allow"
                            },
                            "rules": [
                              {
                                "ruleType": "ApplicationRule",
                                "name": "SpokeInternetSurf",
                                "protocols": [
                                  {
                                    "protocolType": "Http",
                                    "port": 80
                                  },
                                  {
                                    "protocolType": "Https",
                                    "port": 443
                                  }
                                ],
                                "fqdnTags": [],
                                "webCategories": [],
                                "targetFqdns": [
                                  "*"
                                ],
                                "targetUrls": [],
                                "terminateTLS": false,
                                "sourceAddresses": [
                                  "10.20.0.0/16"
                                ],
                                "destinationAddresses": [],
                                "sourceIpGroups": []
                              },
                              {
                                "ruleType": "ApplicationRule",
                                "name": "HubInternetSurf",
                                "protocols": [
                                  {
                                    "protocolType": "Http",
                                    "port": 80
                                  },
                                  {
                                    "protocolType": "Https",
                                    "port": 443
                                  }
                                ],
                                "fqdnTags": [],
                                "webCategories": [],
                                "targetFqdns": [
                                  "*"
                                ],
                                "targetUrls": [],
                                "terminateTLS": false,
                                "sourceAddresses": [
                                  "10.10.0.0/16"
                                ],
                                "destinationAddresses": [],
                                "sourceIpGroups": []
                              },
                              {
                                "ruleType": "ApplicationRule",
                                "name": "OnPremInternetSurf",
                                "protocols": [
                                  {
                                    "protocolType": "Http",
                                    "port": 80
                                  },
                                  {
                                    "protocolType": "Https",
                                    "port": 443
                                  }
                                ],
                                "fqdnTags": [],
                                "webCategories": [],
                                "targetFqdns": [
                                  "*"
                                ],
                                "targetUrls": [],
                                "terminateTLS": false,
                                "sourceAddresses": [
                                  "192.168.0.0/16"
                                ],
                                "destinationAddresses": [],
                                "sourceIpGroups": []
                              }
                            ],
                            "name": "InternetSurfing",
                            "priority": 100
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/firewallPolicies', variables('AzFwPolicyName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/azureFirewalls",
                      "apiVersion": "2021-08-01",
                      "name": "[variables('AzFwName')]",
                      "location": "[parameters('location')]",
                      "zones": [],
                      "properties": {
                        "sku": {
                          "tier": "Premium"
                        },
                        "ipConfigurations": [
                          {
                            "name": "[variables('publiIPAddressName')]",
                            "properties": {
                              "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), 'AzureFirewallSubnet')]"
                              },
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publiIPAddressName'))]"
                              }
                            }
                          }
                        ],
                        "firewallPolicy": {
                          "id": "[resourceId('Microsoft.Network/firewallPolicies', variables('AzFwPolicyName'))]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/firewallPolicies', variables('AzFwPolicyName'))]",
                        "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), 'AzureFirewallSubnet')]",
                        "[resourceId('Microsoft.Network/publicIPAddresses', variables('publiIPAddressName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "AzFwName": {
                      "type": "string",
                      "value": "[variables('AzFwName')]"
                    },
                    "AzFwPolicyName": {
                      "type": "string",
                      "value": "[variables('AzFwPolicyName')]"
                    },
                    "publiIPAddressName": {
                      "type": "string",
                      "value": "[variables('publiIPAddressName')]"
                    },
                    "FwIP": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Network/azureFirewalls', variables('AzFwName')), '2021-08-01').ipConfigurations[0].properties.privateIPAddress]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/virtualNetworks', parameters('HubVnetName'))]"
              ]
            },
            {
              "condition": "[parameters('DeployKV')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('KVname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "keyVaultName": {
                    "value": "[variables('KVname')]"
                  },
                  "objectId": {
                    "value": "[parameters('MyObjectId')]"
                  },
                  "VnetName": {
                    "value": "[parameters('HubVnetName')]"
                  },
                  "SubnetName": {
                    "value": "[parameters('PEsubnetName')]"
                  },
                  "MyIPaddress": {
                    "value": "[parameters('MyIPaddress')]"
                  },
                  "RulesetName": {
                    "value": "[variables('RulesetName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "13496549592849105470"
                    }
                  },
                  "parameters": {
                    "keyVaultName": {
                      "type": "string",
                      "metadata": {
                        "description": "Specifies the name of the key vault."
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Specifies the Azure location where the key vault should be created."
                      }
                    },
                    "enabledForDeployment": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Specifies whether Azure Virtual Machines are permitted to retrieve certificates stored as secrets from the key vault."
                      }
                    },
                    "enabledForDiskEncryption": {
                      "type": "bool",
                      "defaultValue": false,
                      "metadata": {
                        "description": "Specifies whether Azure Disk Encryption is permitted to retrieve secrets from the vault and unwrap keys."
                      }
                    },
                    "enabledForTemplateDeployment": {
                      "type": "bool",
                      "defaultValue": true,
                      "metadata": {
                        "description": "Specifies whether Azure Resource Manager is permitted to retrieve secrets from the key vault."
                      }
                    },
                    "tenantId": {
                      "type": "string",
                      "defaultValue": "[subscription().tenantId]",
                      "metadata": {
                        "description": "Specifies the Azure Active Directory tenant ID that should be used for authenticating requests to the key vault. Get it by using Get-AzSubscription cmdlet."
                      }
                    },
                    "objectId": {
                      "type": "string",
                      "metadata": {
                        "description": "Specifies the object ID of a user, service principal or security group in the Azure Active Directory tenant for the vault. The object ID must be unique for the list of access policies. Get it by using Get-AzADUser or Get-AzADServicePrincipal cmdlets."
                      }
                    },
                    "keysPermissions": {
                      "type": "array",
                      "defaultValue": [
                        "list"
                      ],
                      "metadata": {
                        "description": "Specifies the permissions to keys in the vault. Valid values are: all, encrypt, decrypt, wrapKey, unwrapKey, sign, verify, get, list, create, update, import, delete, backup, restore, recover, and purge."
                      }
                    },
                    "secretsPermissions": {
                      "type": "array",
                      "defaultValue": [
                        "list",
                        "get",
                        "set"
                      ],
                      "metadata": {
                        "description": "Specifies the permissions to secrets in the vault. Valid values are: all, get, list, set, delete, backup, restore, recover, and purge."
                      }
                    },
                    "skuName": {
                      "type": "string",
                      "defaultValue": "standard",
                      "allowedValues": [
                        "standard",
                        "premium"
                      ],
                      "metadata": {
                        "description": "Specifies whether the key vault is a standard vault or a premium vault."
                      }
                    },
                    "VnetName": {
                      "type": "string"
                    },
                    "SubnetName": {
                      "type": "string"
                    },
                    "MyIPaddress": {
                      "type": "string"
                    },
                    "RulesetName": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "RuleName": "[format('KV-{0}', variables('seed'))]",
                    "seed": "[substring(uniqueString(resourceGroup().name, parameters('VnetName')), 0, 5)]",
                    "PEname": "[format('PE-KV-{0}', variables('seed'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.KeyVault/vaults",
                      "apiVersion": "2021-04-01-preview",
                      "name": "[parameters('keyVaultName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "enabledForDeployment": "[parameters('enabledForDeployment')]",
                        "enabledForDiskEncryption": "[parameters('enabledForDiskEncryption')]",
                        "enabledForTemplateDeployment": "[parameters('enabledForTemplateDeployment')]",
                        "tenantId": "[parameters('tenantId')]",
                        "accessPolicies": [
                          {
                            "objectId": "[parameters('objectId')]",
                            "tenantId": "[parameters('tenantId')]",
                            "permissions": {
                              "keys": "[parameters('keysPermissions')]",
                              "secrets": "[parameters('secretsPermissions')]"
                            }
                          }
                        ],
                        "sku": {
                          "name": "[parameters('skuName')]",
                          "family": "A"
                        },
                        "networkAcls": {
                          "defaultAction": "Deny",
                          "bypass": "AzureServices",
                          "ipRules": [
                            {
                              "value": "[format('{0}/32', parameters('MyIPaddress'))]"
                            }
                          ],
                          "virtualNetworkRules": []
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints",
                      "apiVersion": "2021-03-01",
                      "name": "[variables('PEname')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "subnet": {
                          "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('VnetName'), parameters('SubnetName'))]"
                        },
                        "privateLinkServiceConnections": [
                          {
                            "name": "[variables('PEname')]",
                            "properties": {
                              "privateLinkServiceId": "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
                              "groupIds": [
                                "vault"
                              ]
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.KeyVault/vaults', parameters('keyVaultName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateDnsZones",
                      "apiVersion": "2020-06-01",
                      "name": "privatelink.vaultcore.azure.net",
                      "location": "global"
                    },
                    {
                      "type": "Microsoft.Network/privateDnsZones/virtualNetworkLinks",
                      "apiVersion": "2020-06-01",
                      "name": "[format('privatelink.vaultcore.azure.net/{0}', uniqueString(parameters('tenantId')))]",
                      "location": "global",
                      "properties": {
                        "virtualNetwork": {
                          "id": "[resourceId('Microsoft.Network/virtualNetworks', parameters('VnetName'))]"
                        },
                        "registrationEnabled": false
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/privateEndpoints/privateDnsZoneGroups",
                      "apiVersion": "2021-03-01",
                      "name": "[format('{0}/default', variables('PEname'))]",
                      "properties": {
                        "privateDnsZoneConfigs": [
                          {
                            "name": "privatelink-vaultcore-azure-net",
                            "properties": {
                              "privateDnsZoneId": "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/privateDnsZones', 'privatelink.vaultcore.azure.net')]",
                        "[resourceId('Microsoft.Network/privateEndpoints', variables('PEname'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/dnsForwardingRulesets/forwardingRules",
                      "apiVersion": "2020-04-01-preview",
                      "name": "[format('{0}/{1}', parameters('RulesetName'), variables('RuleName'))]",
                      "properties": {
                        "domainName": "privatelink.vaultcore.azure.net.",
                        "forwardingRuleState": "Enabled",
                        "targetDnsServers": [
                          {
                            "ipAddress": "10.10.0.4",
                            "port": 53
                          }
                        ]
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.Network/dnsForwardingRulesets', variables('RulesetName'))]"
              ]
            }
          ],
          "outputs": {
            "HubVnetName": {
              "type": "string",
              "value": "[parameters('HubVnetName')]"
            },
            "PEsubnetName": {
              "type": "string",
              "value": "[parameters('PEsubnetName')]"
            },
            "DNSIp": {
              "type": "string",
              "value": "[if(parameters('DeployDNS'), reference(resourceId('Microsoft.Network/dnsResolvers/inboundEndpoints', split(format('{0}/{1}', variables('ResolverName'), parameters('InSubnetName')), '/')[0], split(format('{0}/{1}', variables('ResolverName'), parameters('InSubnetName')), '/')[1]), '2020-04-01-preview').ipConfigurations[0].privateIpAddress, '')]"
            },
            "RulesetName": {
              "type": "string",
              "value": "[if(parameters('DeployDNS'), variables('RulesetName'), '')]"
            },
            "FwIp": {
              "type": "string",
              "value": "[if(parameters('DeployRT'), reference(resourceId('Microsoft.Resources/deployments', variables('FwName')), '2020-10-01').outputs.FwIP.value, '')]"
            },
            "FwName": {
              "type": "string",
              "value": "[if(parameters('DeployRT'), reference(resourceId('Microsoft.Resources/deployments', variables('FwName')), '2020-10-01').outputs.AzFwName.value, '')]"
            },
            "KvName": {
              "type": "string",
              "value": "[if(parameters('DeployKV'), variables('KVname'), '')]"
            }
          }
        }
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.Resources/resourceGroups', variables('HubRgName'))]"
      ]
    },
    {
      "condition": "[greater(parameters('SpokesNumber'), 0)]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('SpokesDeploy-{0}', parameters('Seed'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "CustomDNSserverAddress": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('HubRgName')), 'Microsoft.Resources/deployments', format('HubEssentialDeploy-{0}', parameters('Seed'))), '2020-10-01').outputs.DNSIp.value]"
          },
          "DeployRT": {
            "value": "[parameters('DeployRT')]"
          },
          "DeployNSG": {
            "value": "[parameters('DeployNSG')]"
          },
          "DeployDNS": {
            "value": "[parameters('DeployDNS')]"
          },
          "FwIP": "[if(parameters('DeployRT'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('HubRgName')), 'Microsoft.Resources/deployments', format('HubEssentialDeploy-{0}', parameters('Seed'))), '2020-10-01').outputs.FwIp.value), createObject('value', ''))]",
          "HubRGname": {
            "value": "[variables('HubRgName')]"
          },
          "HubVnetName": {
            "value": "[variables('HubVnetName')]"
          },
          "location": {
            "value": "[parameters('Location')]"
          },
          "Seed": {
            "value": "[parameters('Seed')]"
          },
          "SpokeRGname": {
            "value": "[variables('SpokeRgName')]"
          },
          "Spokes": {
            "value": "[parameters('SpokesNumber')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.14.85.62628",
              "templateHash": "13252889183021041729"
            }
          },
          "parameters": {
            "HubVnetName": {
              "type": "string"
            },
            "HubRGname": {
              "type": "string"
            },
            "SpokeRGname": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "Seed": {
              "type": "string"
            },
            "Spokes": {
              "type": "int",
              "defaultValue": 1
            },
            "DeployRT": {
              "type": "bool"
            },
            "DeployNSG": {
              "type": "bool"
            },
            "DeployDNS": {
              "type": "bool"
            },
            "FwIP": {
              "type": "string"
            },
            "CustomDNSserverAddress": {
              "type": "string"
            }
          },
          "resources": [
            {
              "copy": {
                "name": "SpokesVnet",
                "count": "[length(range(0, parameters('Spokes')))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('Spoke-VNet-{0}', range(0, parameters('Spokes'))[copyIndex()])]",
              "resourceGroup": "[parameters('SpokeRGname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "virtualNetworkName": {
                    "value": "[format('Spoke-VNet-{0}', range(0, parameters('Spokes'))[copyIndex()])]"
                  },
                  "vnetAddressPrefix": {
                    "value": "[format('10.20.{0}.0/24', range(0, parameters('Spokes'))[copyIndex()])]"
                  },
                  "PEsubnetName": {
                    "value": "[format('PEsubnet-{0}-{1}', range(0, parameters('Spokes'))[copyIndex()], parameters('Seed'))]"
                  },
                  "PEsubnetAddressPrefix": {
                    "value": "[format('10.20.{0}.0/24', range(0, parameters('Spokes'))[copyIndex()])]"
                  },
                  "GatewaySubnetAddressPrefix": {
                    "value": ""
                  },
                  "NSGname": {
                    "value": "[format('NSG-{0}-{1}', range(0, parameters('Spokes'))[copyIndex()], parameters('Seed'))]"
                  },
                  "FwIP": {
                    "value": "[parameters('FwIP')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  },
                  "CustomDNSserver": {
                    "value": "[parameters('CustomDNSserverAddress')]"
                  },
                  "DeployGw": {
                    "value": false
                  },
                  "DeployRT": {
                    "value": "[parameters('DeployRT')]"
                  },
                  "DeployNSG": {
                    "value": "[parameters('DeployNSG')]"
                  },
                  "DeployDNS": {
                    "value": "[parameters('DeployDNS')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "8093875283131725207"
                    }
                  },
                  "parameters": {
                    "virtualNetworkName": {
                      "type": "string"
                    },
                    "vnetAddressPrefix": {
                      "type": "string"
                    },
                    "PEsubnetName": {
                      "type": "string"
                    },
                    "PEsubnetAddressPrefix": {
                      "type": "string"
                    },
                    "GatewaySubnetAddressPrefix": {
                      "type": "string"
                    },
                    "FwIP": {
                      "type": "string"
                    },
                    "CustomDNSserver": {
                      "type": "string"
                    },
                    "NSGname": {
                      "type": "string"
                    },
                    "DeployGw": {
                      "type": "bool"
                    },
                    "DeployRT": {
                      "type": "bool"
                    },
                    "DeployNSG": {
                      "type": "bool"
                    },
                    "DeployDNS": {
                      "type": "bool"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    }
                  },
                  "resources": [
                    {
                      "condition": "[parameters('DeployNSG')]",
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('NSGname')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "securityRules": []
                      }
                    },
                    {
                      "condition": "[parameters('DeployRT')]",
                      "type": "Microsoft.Network/routeTables",
                      "apiVersion": "2021-08-01",
                      "name": "SpokeRT",
                      "location": "[parameters('location')]",
                      "properties": {
                        "disableBgpRoutePropagation": false,
                        "routes": []
                      }
                    },
                    {
                      "condition": "[parameters('DeployRT')]",
                      "type": "Microsoft.Network/routeTables/routes",
                      "apiVersion": "2021-08-01",
                      "name": "SpokeRT/ToFW",
                      "properties": {
                        "addressPrefix": "0.0.0.0/0",
                        "nextHopType": "VirtualAppliance",
                        "nextHopIpAddress": "[parameters('FwIP')]",
                        "hasBgpOverride": false
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/routeTables', 'SpokeRT')]"
                      ]
                    },
                    {
                      "condition": "[parameters('DeployRT')]",
                      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                      "apiVersion": "2021-08-01",
                      "name": "[format('{0}/NoInternetHub', parameters('NSGname'))]",
                      "properties": {
                        "protocol": "Tcp",
                        "sourcePortRange": "*",
                        "sourceAddressPrefix": "*",
                        "destinationAddressPrefix": "Internet",
                        "access": "Deny",
                        "priority": 1000,
                        "direction": "Outbound",
                        "sourcePortRanges": [],
                        "destinationPortRanges": [
                          "443",
                          "80"
                        ],
                        "sourceAddressPrefixes": [],
                        "destinationAddressPrefixes": []
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('NSGname'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('virtualNetworkName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('vnetAddressPrefix')]"
                          ]
                        },
                        "dhcpOptions": {
                          "dnsServers": "[if(parameters('DeployDNS'), createArray(parameters('CustomDNSserver')), null())]"
                        },
                        "subnets": [
                          {
                            "name": "[parameters('PEsubnetName')]",
                            "properties": {
                              "addressPrefix": "[parameters('PEsubnetAddressPrefix')]",
                              "privateEndpointNetworkPolicies": "Disabled",
                              "privateLinkServiceNetworkPolicies": "Enabled",
                              "networkSecurityGroup": "[if(parameters('DeployNSG'), createObject('id', resourceId('Microsoft.Network/networkSecurityGroups', parameters('NSGname'))), null())]",
                              "routeTable": "[if(parameters('DeployRT'), createObject('id', resourceId('Microsoft.Network/routeTables', 'SpokeRT')), null())]"
                            }
                          }
                        ]
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('NSGname'))]",
                        "[resourceId('Microsoft.Network/routeTables', 'SpokeRT')]"
                      ]
                    },
                    {
                      "condition": "[parameters('DeployGw')]",
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2022-01-01",
                      "name": "[format('{0}/{1}', parameters('virtualNetworkName'), 'GatewaySubnet')]",
                      "properties": {
                        "addressPrefix": "[parameters('GatewaySubnetAddressPrefix')]",
                        "privateEndpointNetworkPolicies": "Disabled",
                        "privateLinkServiceNetworkPolicies": "Enabled"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/virtualNetworks', parameters('virtualNetworkName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "virtualNetworkRg": {
                      "type": "string",
                      "value": "[resourceGroup().name]"
                    },
                    "virtualNetworkName": {
                      "type": "string",
                      "value": "[parameters('virtualNetworkName')]"
                    },
                    "NsgName": {
                      "type": "string",
                      "value": "[parameters('NSGname')]"
                    }
                  }
                }
              }
            },
            {
              "copy": {
                "name": "Hub2Spoke",
                "count": "[length(range(0, parameters('Spokes')))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('Hub2Spoke-{0}', range(0, parameters('Spokes'))[copyIndex()])]",
              "resourceGroup": "[parameters('HubRGname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "virtualNetworkName": {
                    "value": "[parameters('HubVnetName')]"
                  },
                  "allowForwardedTraffic": {
                    "value": true
                  },
                  "allowGatewayTransit": {
                    "value": false
                  },
                  "allowVirtualNetworkAccess": {
                    "value": true
                  },
                  "useRemoteGateways": {
                    "value": false
                  },
                  "remoteResourceGroup": {
                    "value": "[parameters('SpokeRGname')]"
                  },
                  "remoteVirtualNetworkName": {
                    "value": "[format('Spoke-VNet-{0}', range(0, parameters('Spokes'))[copyIndex()])]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "6588622071466963370"
                    }
                  },
                  "parameters": {
                    "virtualNetworkName": {
                      "type": "string"
                    },
                    "allowForwardedTraffic": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "allowGatewayTransit": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "allowVirtualNetworkAccess": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "useRemoteGateways": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "remoteResourceGroup": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}/Peering-To-{1}', parameters('virtualNetworkName'), parameters('remoteVirtualNetworkName'))]",
                      "properties": {
                        "allowForwardedTraffic": "[parameters('allowForwardedTraffic')]",
                        "allowGatewayTransit": "[parameters('allowGatewayTransit')]",
                        "allowVirtualNetworkAccess": "[parameters('allowVirtualNetworkAccess')]",
                        "useRemoteGateways": "[parameters('useRemoteGateways')]",
                        "remoteVirtualNetwork": {
                          "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('remoteResourceGroup')), 'Microsoft.Network/virtualNetworks', parameters('remoteVirtualNetworkName'))]"
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "SpokesVnet"
              ]
            },
            {
              "copy": {
                "name": "Spoke2Hub",
                "count": "[length(range(0, parameters('Spokes')))]"
              },
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[format('Spoke2Hub-{0}', range(0, parameters('Spokes'))[copyIndex()])]",
              "resourceGroup": "[parameters('SpokeRGname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "virtualNetworkName": {
                    "value": "[format('Spoke-VNet-{0}', range(0, parameters('Spokes'))[copyIndex()])]"
                  },
                  "allowForwardedTraffic": {
                    "value": true
                  },
                  "allowGatewayTransit": {
                    "value": false
                  },
                  "allowVirtualNetworkAccess": {
                    "value": true
                  },
                  "useRemoteGateways": {
                    "value": false
                  },
                  "remoteResourceGroup": {
                    "value": "[parameters('HubRGname')]"
                  },
                  "remoteVirtualNetworkName": {
                    "value": "[parameters('HubVnetName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "6588622071466963370"
                    }
                  },
                  "parameters": {
                    "virtualNetworkName": {
                      "type": "string"
                    },
                    "allowForwardedTraffic": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "allowGatewayTransit": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "allowVirtualNetworkAccess": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "useRemoteGateways": {
                      "type": "bool",
                      "defaultValue": true
                    },
                    "remoteResourceGroup": {
                      "type": "string"
                    },
                    "remoteVirtualNetworkName": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/virtualNetworkPeerings",
                      "apiVersion": "2021-02-01",
                      "name": "[format('{0}/Peering-To-{1}', parameters('virtualNetworkName'), parameters('remoteVirtualNetworkName'))]",
                      "properties": {
                        "allowForwardedTraffic": "[parameters('allowForwardedTraffic')]",
                        "allowGatewayTransit": "[parameters('allowGatewayTransit')]",
                        "allowVirtualNetworkAccess": "[parameters('allowVirtualNetworkAccess')]",
                        "useRemoteGateways": "[parameters('useRemoteGateways')]",
                        "remoteVirtualNetwork": {
                          "id": "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('remoteResourceGroup')), 'Microsoft.Network/virtualNetworks', parameters('remoteVirtualNetworkName'))]"
                        }
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "SpokesVnet"
              ]
            }
          ],
          "outputs": {
            "SpokesVnetName": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, parameters('Spokes')))]",
                "input": {
                  "name": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('SpokeRGname')), 'Microsoft.Resources/deployments', format('Spoke-VNet-{0}', range(0, parameters('Spokes'))[range(0, parameters('Spokes'))[copyIndex()]])), '2020-10-01').outputs.virtualNetworkName.value]"
                }
              }
            },
            "SpokesNsgName": {
              "type": "array",
              "copy": {
                "count": "[length(range(0, parameters('Spokes')))]",
                "input": {
                  "name": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('SpokeRGname')), 'Microsoft.Resources/deployments', format('Spoke-VNet-{0}', range(0, parameters('Spokes'))[range(0, parameters('Spokes'))[copyIndex()]])), '2020-10-01').outputs.NsgName.value]"
                }
              }
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('HubRgName')), 'Microsoft.Resources/deployments', format('HubEssentialDeploy-{0}', parameters('Seed')))]"
      ]
    },
    {
      "condition": "[parameters('DeployOnPrem')]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2020-10-01",
      "name": "[format('OnPremDeploy-{0}', parameters('Seed'))]",
      "location": "[deployment().location]",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "adminPassword": {
            "value": "[parameters('adminPassword')]"
          },
          "CustomDNSserverAddress": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('HubRgName')), 'Microsoft.Resources/deployments', format('HubEssentialDeploy-{0}', parameters('Seed'))), '2020-10-01').outputs.DNSIp.value]"
          },
          "DeployProxy": {
            "value": "[parameters('DeployProxy')]"
          },
          "DeployRT": {
            "value": "[parameters('DeployRT')]"
          },
          "DeployNSG": {
            "value": "[parameters('DeployNSG')]"
          },
          "HubRGname": {
            "value": "[variables('HubRgName')]"
          },
          "HubVnetName": {
            "value": "[variables('HubVnetName')]"
          },
          "location": {
            "value": "[parameters('Location')]"
          },
          "MyIPaddress": {
            "value": "[parameters('MyIP')]"
          },
          "MyObjectId": {
            "value": "[parameters('MyObjectId')]"
          },
          "OnPremGWvnetSubnetAddressPrefix": {
            "value": "[parameters('OnPremGWvnetSubnetAddressPrefix')]"
          },
          "OnPremPEvnetSubnetAddressPrefix": {
            "value": "[parameters('OnPremPEvnetSubnetAddressPrefix')]"
          },
          "OnPremDMZvnetSubnetAddressPrefix": {
            "value": "[parameters('OnPremDMZvnetSubnetAddressPrefix')]"
          },
          "OnPremRGname": {
            "value": "[variables('OnPremRGname')]"
          },
          "OnPremVnetAddressPrefix": {
            "value": "[parameters('OnPremVnetAddressPrefix')]"
          },
          "OnPremVnetName": {
            "value": "[variables('OnPremVnetName')]"
          },
          "RulesetName": {
            "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('HubRgName')), 'Microsoft.Resources/deployments', format('HubEssentialDeploy-{0}', parameters('Seed'))), '2020-10-01').outputs.RulesetName.value]"
          },
          "Seed": {
            "value": "[parameters('Seed')]"
          },
          "FwIP": "[if(parameters('DeployRT'), createObject('value', reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('HubRgName')), 'Microsoft.Resources/deployments', format('HubEssentialDeploy-{0}', parameters('Seed'))), '2020-10-01').outputs.FwIp.value), createObject('value', ''))]"
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.14.85.62628",
              "templateHash": "14620685077866061959"
            }
          },
          "parameters": {
            "OnPremRGname": {
              "type": "string"
            },
            "HubRGname": {
              "type": "string"
            },
            "location": {
              "type": "string"
            },
            "OnPremVnetName": {
              "type": "string"
            },
            "OnPremVnetAddressPrefix": {
              "type": "string"
            },
            "OnPremGWvnetSubnetAddressPrefix": {
              "type": "string"
            },
            "OnPremPEvnetSubnetAddressPrefix": {
              "type": "string"
            },
            "OnPremDMZvnetSubnetAddressPrefix": {
              "type": "string"
            },
            "HubVnetName": {
              "type": "string"
            },
            "CustomDNSserverAddress": {
              "type": "string"
            },
            "DeployProxy": {
              "type": "bool"
            },
            "DeployRT": {
              "type": "bool"
            },
            "DeployNSG": {
              "type": "bool"
            },
            "FwIP": {
              "type": "string"
            },
            "adminPassword": {
              "type": "securestring"
            },
            "Seed": {
              "type": "string"
            },
            "MyObjectId": {
              "type": "string"
            },
            "MyIPaddress": {
              "type": "string"
            },
            "RulesetName": {
              "type": "string"
            }
          },
          "variables": {
            "networkSecurityGroupName": "[format('NSG-{0}', parameters('Seed'))]",
            "HubToOnPremConnectionName": "[format('Hub2OnPrem-{0}', parameters('Seed'))]",
            "OnPremToHubConnectionName": "[format('OnPrem2Hub-{0}', parameters('Seed'))]",
            "OnPremVirtualNetworkGWName": "[format('OnPremVNGW-{0}', parameters('Seed'))]",
            "HubVirtualNetworkGWName": "[format('HubVNGW-{0}', parameters('Seed'))]",
            "Proxyname": "[format('Proxy-{0}', parameters('Seed'))]",
            "PEsubnetName": "PE-Subnet",
            "DMZsubnetName": "DMZ-Subnet"
          },
          "resources": [
            {
              "type": "Microsoft.Resources/resourceGroups",
              "apiVersion": "2021-01-01",
              "name": "[parameters('OnPremRGname')]",
              "location": "[parameters('location')]"
            },
            {
              "condition": "[parameters('DeployNSG')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[parameters('OnPremRGname')]",
              "resourceGroup": "[parameters('OnPremRGname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "NSGname": {
                    "value": "[variables('networkSecurityGroupName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "9707448790784301121"
                    }
                  },
                  "parameters": {
                    "NSGname": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('NSGname')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "securityRules": []
                      }
                    }
                  ],
                  "outputs": {
                    "NsgId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/networkSecurityGroups', parameters('NSGname'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRGname'))]"
              ]
            },
            {
              "condition": "[parameters('DeployRT')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "OnPremRT",
              "resourceGroup": "[parameters('OnPremRGname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "RTname": {
                    "value": "OnPremRT"
                  },
                  "location": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRGname')), '2021-01-01', 'full').location]"
                  },
                  "FwIP": {
                    "value": "[parameters('FwIP')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "3606277552070555563"
                    }
                  },
                  "parameters": {
                    "RTname": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]"
                    },
                    "disableBgpRoutePropagation": {
                      "type": "bool",
                      "defaultValue": false
                    },
                    "FwIP": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/routeTables",
                      "apiVersion": "2021-08-01",
                      "name": "[parameters('RTname')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "disableBgpRoutePropagation": "[parameters('disableBgpRoutePropagation')]",
                        "routes": []
                      }
                    },
                    {
                      "type": "Microsoft.Network/routeTables/routes",
                      "apiVersion": "2021-08-01",
                      "name": "[format('{0}/ToFW', parameters('RTname'))]",
                      "properties": {
                        "addressPrefix": "0.0.0.0/0",
                        "nextHopType": "VirtualAppliance",
                        "nextHopIpAddress": "[parameters('FwIP')]",
                        "hasBgpOverride": false
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/routeTables', parameters('RTname'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "RTid": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/routeTables', parameters('RTname'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRGname'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[parameters('OnPremVnetName')]",
              "resourceGroup": "[parameters('OnPremRGname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "virtualNetworkName": {
                    "value": "[parameters('OnPremVnetName')]"
                  },
                  "vnetAddressPrefix": {
                    "value": "[parameters('OnPremVnetAddressPrefix')]"
                  },
                  "CustomDNSserver": {
                    "value": "[parameters('CustomDNSserverAddress')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "676544018214685287"
                    }
                  },
                  "parameters": {
                    "virtualNetworkName": {
                      "type": "string"
                    },
                    "vnetAddressPrefix": {
                      "type": "string"
                    },
                    "CustomDNSserver": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks",
                      "apiVersion": "2021-02-01",
                      "name": "[parameters('virtualNetworkName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "addressSpace": {
                          "addressPrefixes": [
                            "[parameters('vnetAddressPrefix')]"
                          ]
                        },
                        "dhcpOptions": "[if(equals(parameters('CustomDNSserver'), ''), createObject(), createObject('dnsServers', createArray(parameters('CustomDNSserver'))))]",
                        "subnets": []
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRGname'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('DMZsubnetName')]",
              "resourceGroup": "[parameters('OnPremRGname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "NsgId": {
                    "value": ""
                  },
                  "RtId": {
                    "value": ""
                  },
                  "SubnetName": {
                    "value": "[variables('DMZsubnetName')]"
                  },
                  "SubnetAddressPrefix": {
                    "value": "[parameters('OnPremDMZvnetSubnetAddressPrefix')]"
                  },
                  "VNetName": {
                    "value": "[parameters('OnPremVnetName')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "11555614204196144000"
                    }
                  },
                  "parameters": {
                    "VNetName": {
                      "type": "string"
                    },
                    "SubnetName": {
                      "type": "string"
                    },
                    "SubnetAddressPrefix": {
                      "type": "string"
                    },
                    "NsgId": {
                      "type": "string"
                    },
                    "RtId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2022-05-01",
                      "name": "[format('{0}/{1}', parameters('VNetName'), parameters('SubnetName'))]",
                      "properties": {
                        "addressPrefix": "[parameters('SubnetAddressPrefix')]",
                        "privateEndpointNetworkPolicies": "Disabled",
                        "privateLinkServiceNetworkPolicies": "Enabled",
                        "networkSecurityGroup": "[if(equals(parameters('NsgId'), ''), null(), createObject('id', parameters('NsgId')))]",
                        "routeTable": "[if(equals(parameters('RtId'), ''), null(), createObject('id', parameters('RtId')))]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRGname'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRGname')), 'Microsoft.Resources/deployments', parameters('OnPremVnetName'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "GatewaySubnet",
              "resourceGroup": "[parameters('OnPremRGname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "NsgId": {
                    "value": ""
                  },
                  "RtId": {
                    "value": ""
                  },
                  "SubnetName": {
                    "value": "GatewaySubnet"
                  },
                  "VNetName": {
                    "value": "[parameters('OnPremVnetName')]"
                  },
                  "SubnetAddressPrefix": {
                    "value": "[parameters('OnPremGWvnetSubnetAddressPrefix')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "11555614204196144000"
                    }
                  },
                  "parameters": {
                    "VNetName": {
                      "type": "string"
                    },
                    "SubnetName": {
                      "type": "string"
                    },
                    "SubnetAddressPrefix": {
                      "type": "string"
                    },
                    "NsgId": {
                      "type": "string"
                    },
                    "RtId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2022-05-01",
                      "name": "[format('{0}/{1}', parameters('VNetName'), parameters('SubnetName'))]",
                      "properties": {
                        "addressPrefix": "[parameters('SubnetAddressPrefix')]",
                        "privateEndpointNetworkPolicies": "Disabled",
                        "privateLinkServiceNetworkPolicies": "Enabled",
                        "networkSecurityGroup": "[if(equals(parameters('NsgId'), ''), null(), createObject('id', parameters('NsgId')))]",
                        "routeTable": "[if(equals(parameters('RtId'), ''), null(), createObject('id', parameters('RtId')))]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRGname')), 'Microsoft.Resources/deployments', variables('DMZsubnetName'))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRGname'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "PEsubnet",
              "resourceGroup": "[parameters('OnPremRGname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "NsgId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRGname')), 'Microsoft.Resources/deployments', parameters('OnPremRGname')), '2020-10-01').outputs.NsgId.value]"
                  },
                  "RtId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRGname')), 'Microsoft.Resources/deployments', 'OnPremRT'), '2020-10-01').outputs.RTid.value]"
                  },
                  "SubnetName": {
                    "value": "PEsubnet"
                  },
                  "VNetName": {
                    "value": "[parameters('OnPremVnetName')]"
                  },
                  "SubnetAddressPrefix": {
                    "value": "[parameters('OnPremPEvnetSubnetAddressPrefix')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "11555614204196144000"
                    }
                  },
                  "parameters": {
                    "VNetName": {
                      "type": "string"
                    },
                    "SubnetName": {
                      "type": "string"
                    },
                    "SubnetAddressPrefix": {
                      "type": "string"
                    },
                    "NsgId": {
                      "type": "string"
                    },
                    "RtId": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/virtualNetworks/subnets",
                      "apiVersion": "2022-05-01",
                      "name": "[format('{0}/{1}', parameters('VNetName'), parameters('SubnetName'))]",
                      "properties": {
                        "addressPrefix": "[parameters('SubnetAddressPrefix')]",
                        "privateEndpointNetworkPolicies": "Disabled",
                        "privateLinkServiceNetworkPolicies": "Enabled",
                        "networkSecurityGroup": "[if(equals(parameters('NsgId'), ''), null(), createObject('id', parameters('NsgId')))]",
                        "routeTable": "[if(equals(parameters('RtId'), ''), null(), createObject('id', parameters('RtId')))]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRGname')), 'Microsoft.Resources/deployments', 'GatewaySubnet')]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRGname')), 'Microsoft.Resources/deployments', parameters('OnPremRGname'))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRGname'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRGname')), 'Microsoft.Resources/deployments', 'OnPremRT')]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('OnPremVirtualNetworkGWName')]",
              "resourceGroup": "[parameters('OnPremRGname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "VirtualNetGwName": {
                    "value": "[variables('OnPremVirtualNetworkGWName')]"
                  },
                  "VnetName": {
                    "value": "[parameters('OnPremVnetName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "9265682868260294736"
                    }
                  },
                  "parameters": {
                    "VirtualNetGwName": {
                      "type": "string"
                    },
                    "GW_pip_name": {
                      "type": "string",
                      "defaultValue": "Onprem-GW-pip"
                    },
                    "VnetName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "subnetName": "GatewaySubnet",
                    "RgName": "[resourceGroup().name]",
                    "SubscriptionId": "[subscription().id]",
                    "resourceId": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/virtualNetworkGateways/{2}/ipConfigurations/default', variables('SubscriptionId'), variables('RgName'), parameters('VirtualNetGwName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2022-07-01",
                      "name": "[parameters('GW_pip_name')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "Standard",
                        "tier": "Regional"
                      },
                      "properties": {
                        "publicIPAllocationMethod": "Static",
                        "idleTimeoutInMinutes": 4,
                        "publicIPAddressVersion": "IPv4"
                      }
                    },
                    {
                      "type": "Microsoft.Network/virtualNetworkGateways",
                      "apiVersion": "2022-07-01",
                      "name": "[parameters('VirtualNetGwName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "enablePrivateIpAddress": false,
                        "ipConfigurations": [
                          {
                            "name": "default",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('GW_pip_name'))]"
                              },
                              "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('VnetName'), variables('subnetName'))]"
                              }
                            }
                          }
                        ],
                        "natRules": [],
                        "virtualNetworkGatewayPolicyGroups": [],
                        "enableBgpRouteTranslationForNat": false,
                        "disableIPSecReplayProtection": false,
                        "sku": {
                          "name": "VpnGw1",
                          "tier": "VpnGw1"
                        },
                        "gatewayType": "Vpn",
                        "vpnType": "RouteBased",
                        "enableBgp": false,
                        "activeActive": false,
                        "vpnGatewayGeneration": "Generation1",
                        "allowRemoteVnetTraffic": false,
                        "allowVirtualWanTraffic": false
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', parameters('GW_pip_name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "VNetGwId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('VirtualNetGwName'))]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRGname')), 'Microsoft.Resources/deployments', 'GatewaySubnet')]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRGname'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('HubVirtualNetworkGWName')]",
              "resourceGroup": "[parameters('HubRGname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "VirtualNetGwName": {
                    "value": "[variables('HubVirtualNetworkGWName')]"
                  },
                  "VnetName": {
                    "value": "[parameters('HubVnetName')]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "9265682868260294736"
                    }
                  },
                  "parameters": {
                    "VirtualNetGwName": {
                      "type": "string"
                    },
                    "GW_pip_name": {
                      "type": "string",
                      "defaultValue": "Onprem-GW-pip"
                    },
                    "VnetName": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    }
                  },
                  "variables": {
                    "subnetName": "GatewaySubnet",
                    "RgName": "[resourceGroup().name]",
                    "SubscriptionId": "[subscription().id]",
                    "resourceId": "[format('/subscriptions/{0}/resourceGroups/{1}/providers/Microsoft.Network/virtualNetworkGateways/{2}/ipConfigurations/default', variables('SubscriptionId'), variables('RgName'), parameters('VirtualNetGwName'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/publicIPAddresses",
                      "apiVersion": "2022-07-01",
                      "name": "[parameters('GW_pip_name')]",
                      "location": "[parameters('location')]",
                      "sku": {
                        "name": "Standard",
                        "tier": "Regional"
                      },
                      "properties": {
                        "publicIPAllocationMethod": "Static",
                        "idleTimeoutInMinutes": 4,
                        "publicIPAddressVersion": "IPv4"
                      }
                    },
                    {
                      "type": "Microsoft.Network/virtualNetworkGateways",
                      "apiVersion": "2022-07-01",
                      "name": "[parameters('VirtualNetGwName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "enablePrivateIpAddress": false,
                        "ipConfigurations": [
                          {
                            "name": "default",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "publicIPAddress": {
                                "id": "[resourceId('Microsoft.Network/publicIPAddresses', parameters('GW_pip_name'))]"
                              },
                              "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('VnetName'), variables('subnetName'))]"
                              }
                            }
                          }
                        ],
                        "natRules": [],
                        "virtualNetworkGatewayPolicyGroups": [],
                        "enableBgpRouteTranslationForNat": false,
                        "disableIPSecReplayProtection": false,
                        "sku": {
                          "name": "VpnGw1",
                          "tier": "VpnGw1"
                        },
                        "gatewayType": "Vpn",
                        "vpnType": "RouteBased",
                        "enableBgp": false,
                        "activeActive": false,
                        "vpnGatewayGeneration": "Generation1",
                        "allowRemoteVnetTraffic": false,
                        "allowVirtualWanTraffic": false
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/publicIPAddresses', parameters('GW_pip_name'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "VNetGwId": {
                      "type": "string",
                      "value": "[resourceId('Microsoft.Network/virtualNetworkGateways', parameters('VirtualNetGwName'))]"
                    }
                  }
                }
              }
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('HubToOnPremConnectionName')]",
              "resourceGroup": "[parameters('HubRGname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "connection_name": {
                    "value": "[variables('HubToOnPremConnectionName')]"
                  },
                  "LocalGWId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('HubRGname')), 'Microsoft.Resources/deployments', variables('HubVirtualNetworkGWName')), '2020-10-01').outputs.VNetGwId.value]"
                  },
                  "RemoteGWId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRGname')), 'Microsoft.Resources/deployments', variables('OnPremVirtualNetworkGWName')), '2020-10-01').outputs.VNetGwId.value]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "11595627890722591121"
                    }
                  },
                  "parameters": {
                    "connection_name": {
                      "type": "string"
                    },
                    "LocalGWId": {
                      "type": "string"
                    },
                    "RemoteGWId": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/connections",
                      "apiVersion": "2022-07-01",
                      "name": "[parameters('connection_name')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "virtualNetworkGateway1": {
                          "id": "[parameters('RemoteGWId')]"
                        },
                        "virtualNetworkGateway2": {
                          "id": "[parameters('LocalGWId')]"
                        },
                        "connectionType": "Vnet2Vnet",
                        "connectionProtocol": "IKEv2",
                        "routingWeight": 0,
                        "sharedKey": "Azure.123!",
                        "enableBgp": false,
                        "useLocalAzureIpAddress": false,
                        "usePolicyBasedTrafficSelectors": false,
                        "ipsecPolicies": [],
                        "trafficSelectorPolicies": [],
                        "expressRouteGatewayBypass": false,
                        "enablePrivateLinkFastPath": false,
                        "dpdTimeoutSeconds": 0,
                        "connectionMode": "Default",
                        "gatewayCustomBgpIpAddresses": []
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('HubRGname')), 'Microsoft.Resources/deployments', variables('HubVirtualNetworkGWName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRGname')), 'Microsoft.Resources/deployments', variables('OnPremVirtualNetworkGWName'))]"
              ]
            },
            {
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('OnPremToHubConnectionName')]",
              "resourceGroup": "[parameters('OnPremRGname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "connection_name": {
                    "value": "[variables('OnPremToHubConnectionName')]"
                  },
                  "LocalGWId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRGname')), 'Microsoft.Resources/deployments', variables('OnPremVirtualNetworkGWName')), '2020-10-01').outputs.VNetGwId.value]"
                  },
                  "RemoteGWId": {
                    "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('HubRGname')), 'Microsoft.Resources/deployments', variables('HubVirtualNetworkGWName')), '2020-10-01').outputs.VNetGwId.value]"
                  },
                  "location": {
                    "value": "[parameters('location')]"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "11595627890722591121"
                    }
                  },
                  "parameters": {
                    "connection_name": {
                      "type": "string"
                    },
                    "LocalGWId": {
                      "type": "string"
                    },
                    "RemoteGWId": {
                      "type": "string"
                    },
                    "location": {
                      "type": "string"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/connections",
                      "apiVersion": "2022-07-01",
                      "name": "[parameters('connection_name')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "virtualNetworkGateway1": {
                          "id": "[parameters('RemoteGWId')]"
                        },
                        "virtualNetworkGateway2": {
                          "id": "[parameters('LocalGWId')]"
                        },
                        "connectionType": "Vnet2Vnet",
                        "connectionProtocol": "IKEv2",
                        "routingWeight": 0,
                        "sharedKey": "Azure.123!",
                        "enableBgp": false,
                        "useLocalAzureIpAddress": false,
                        "usePolicyBasedTrafficSelectors": false,
                        "ipsecPolicies": [],
                        "trafficSelectorPolicies": [],
                        "expressRouteGatewayBypass": false,
                        "enablePrivateLinkFastPath": false,
                        "dpdTimeoutSeconds": 0,
                        "connectionMode": "Default",
                        "gatewayCustomBgpIpAddresses": []
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('HubRGname')), 'Microsoft.Resources/deployments', variables('HubVirtualNetworkGWName'))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRGname'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRGname')), 'Microsoft.Resources/deployments', variables('OnPremVirtualNetworkGWName'))]"
              ]
            },
            {
              "condition": "[parameters('DeployProxy')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "[variables('Proxyname')]",
              "resourceGroup": "[parameters('OnPremRGname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "vmName": {
                    "value": "[variables('Proxyname')]"
                  },
                  "virtualNetworkName": {
                    "value": "[parameters('OnPremVnetName')]"
                  },
                  "subnetName": {
                    "value": "[variables('DMZsubnetName')]"
                  },
                  "adminPassword": {
                    "value": "[parameters('adminPassword')]"
                  },
                  "location": {
                    "value": "[reference(subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRGname')), '2021-01-01', 'full').location]"
                  },
                  "CustomDnsServer": {
                    "value": "168.63.129.16"
                  },
                  "Command": {
                    "value": "sh && sudo apt-get update && sudo apt-get install -y squid apache2-utils && sudo wget https://raw.githubusercontent.com/gderossilive/CoreInfra/master/Files/Whitelist.txt -O /etc/squid/whitelist.txt && sudo wget https://raw.githubusercontent.com/gderossilive/CoreInfra/master/Files/squid.conf -O /etc/squid/squid.conf && sudo systemctl restart squid"
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "10428200565988315121"
                    }
                  },
                  "parameters": {
                    "adminUsername": {
                      "type": "string",
                      "defaultValue": "gdradmin",
                      "metadata": {
                        "description": "Username for the Virtual Machine."
                      }
                    },
                    "adminPassword": {
                      "type": "securestring",
                      "minLength": 12,
                      "metadata": {
                        "description": "Password for the Virtual Machine."
                      }
                    },
                    "dnsLabelPrefix": {
                      "type": "string",
                      "defaultValue": "[toLower(format('{0}-{1}', parameters('vmName'), uniqueString(resourceGroup().id, parameters('vmName'))))]",
                      "metadata": {
                        "description": "Unique DNS Name for the Public IP used to access the Virtual Machine."
                      }
                    },
                    "publicIPAllocationMethod": {
                      "type": "string",
                      "defaultValue": "Dynamic",
                      "allowedValues": [
                        "Dynamic",
                        "Static"
                      ],
                      "metadata": {
                        "description": "Allocation method for the Public IP used to access the Virtual Machine."
                      }
                    },
                    "publicIpSku": {
                      "type": "string",
                      "defaultValue": "Basic",
                      "allowedValues": [
                        "Basic",
                        "Standard"
                      ],
                      "metadata": {
                        "description": "SKU for the Public IP used to access the Virtual Machine."
                      }
                    },
                    "vmSize": {
                      "type": "string",
                      "defaultValue": "Standard_B2ms",
                      "metadata": {
                        "description": "Size of the virtual machine."
                      }
                    },
                    "location": {
                      "type": "string",
                      "defaultValue": "[resourceGroup().location]",
                      "metadata": {
                        "description": "Location for all resources."
                      }
                    },
                    "vmName": {
                      "type": "string",
                      "defaultValue": "simple-vm",
                      "metadata": {
                        "description": "Name of the virtual machine."
                      }
                    },
                    "virtualNetworkName": {
                      "type": "string",
                      "metadata": {
                        "description": "(Existing) Virtual Network and subent where to join the VM"
                      }
                    },
                    "subnetName": {
                      "type": "string"
                    },
                    "Command": {
                      "type": "string",
                      "defaultValue": ""
                    },
                    "CustomDnsServer": {
                      "type": "string",
                      "defaultValue": ""
                    }
                  },
                  "variables": {
                    "seed": "[substring(uniqueString(parameters('vmName'), parameters('virtualNetworkName'), parameters('subnetName')), 0, 5)]",
                    "nicName": "[format('{0}-Nic-{1}', parameters('vmName'), variables('seed'))]",
                    "publicIpName": "[format('{0}-PIP-{1}', parameters('vmName'), variables('seed'))]"
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkInterfaces",
                      "apiVersion": "2021-02-01",
                      "name": "[variables('nicName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "ipConfigurations": [
                          {
                            "name": "ipconfig1",
                            "properties": {
                              "privateIPAllocationMethod": "Dynamic",
                              "subnet": {
                                "id": "[resourceId('Microsoft.Network/virtualNetworks/subnets', parameters('virtualNetworkName'), parameters('subnetName'))]"
                              }
                            }
                          }
                        ],
                        "dnsSettings": {
                          "dnsServers": "[if(equals(parameters('CustomDnsServer'), ''), createArray(), createArray(parameters('CustomDnsServer')))]"
                        }
                      }
                    },
                    {
                      "type": "Microsoft.Compute/virtualMachines",
                      "apiVersion": "2021-03-01",
                      "name": "[parameters('vmName')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "hardwareProfile": {
                          "vmSize": "[parameters('vmSize')]"
                        },
                        "osProfile": {
                          "computerName": "[parameters('vmName')]",
                          "adminUsername": "[parameters('adminUsername')]",
                          "adminPassword": "[parameters('adminPassword')]"
                        },
                        "storageProfile": {
                          "imageReference": {
                            "publisher": "Canonical",
                            "offer": "UbuntuServer",
                            "sku": "18.04-LTS",
                            "version": "latest"
                          },
                          "osDisk": {
                            "createOption": "FromImage",
                            "managedDisk": {
                              "storageAccountType": "StandardSSD_LRS"
                            }
                          }
                        },
                        "networkProfile": {
                          "networkInterfaces": [
                            {
                              "id": "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                            }
                          ]
                        },
                        "diagnosticsProfile": {
                          "bootDiagnostics": {
                            "enabled": false
                          }
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Network/networkInterfaces', variables('nicName'))]"
                      ]
                    },
                    {
                      "condition": "[not(equals(parameters('Command'), ''))]",
                      "type": "Microsoft.Compute/virtualMachines/extensions",
                      "apiVersion": "2022-08-01",
                      "name": "[format('{0}/{1}', parameters('vmName'), 'CustomScriptExtension')]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "publisher": "Microsoft.Azure.Extensions",
                        "type": "CustomScript",
                        "typeHandlerVersion": "2.1",
                        "autoUpgradeMinorVersion": true,
                        "settings": {
                          "skipDos2Unix": false,
                          "timestamp": 123456789
                        },
                        "protectedSettings": {
                          "commandToExecute": "[parameters('Command')]"
                        }
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    },
                    {
                      "type": "Microsoft.DevTestLab/schedules",
                      "apiVersion": "2018-09-15",
                      "name": "[format('shutdown-computevm-{0}', parameters('vmName'))]",
                      "location": "[parameters('location')]",
                      "properties": {
                        "status": "Enabled",
                        "taskType": "ComputeVmShutdownTask",
                        "dailyRecurrence": {
                          "time": "1900"
                        },
                        "timeZoneId": "W. Europe Standard Time",
                        "notificationSettings": {
                          "status": "Disabled",
                          "timeInMinutes": 30,
                          "notificationLocale": "en"
                        },
                        "targetResourceId": "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      },
                      "dependsOn": [
                        "[resourceId('Microsoft.Compute/virtualMachines', parameters('vmName'))]"
                      ]
                    }
                  ],
                  "outputs": {
                    "hostname": {
                      "type": "string",
                      "value": "[reference(resourceId('Microsoft.Compute/virtualMachines', parameters('vmName')), '2021-03-01').osProfile.computerName]"
                    }
                  }
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRGname')), 'Microsoft.Resources/deployments', variables('DMZsubnetName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('HubRGname')), 'Microsoft.Resources/deployments', variables('HubToOnPremConnectionName'))]",
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRGname')), 'Microsoft.Resources/deployments', variables('OnPremToHubConnectionName'))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRGname'))]"
              ]
            },
            {
              "condition": "[parameters('DeployNSG')]",
              "type": "Microsoft.Resources/deployments",
              "apiVersion": "2020-10-01",
              "name": "NoInternetOnPrem",
              "resourceGroup": "[parameters('OnPremRGname')]",
              "properties": {
                "expressionEvaluationOptions": {
                  "scope": "inner"
                },
                "mode": "Incremental",
                "parameters": {
                  "sourceAddressPrefixes": {
                    "value": []
                  },
                  "access": {
                    "value": "Deny"
                  },
                  "NsgName": {
                    "value": "[variables('networkSecurityGroupName')]"
                  },
                  "RuleName": {
                    "value": "NoInternet"
                  },
                  "protocol": {
                    "value": "Tcp"
                  },
                  "sourcePortRange": {
                    "value": "*"
                  },
                  "priority": {
                    "value": 1000
                  },
                  "sourceAddressPrefix": {
                    "value": "*"
                  },
                  "destinationAddressPrefix": {
                    "value": "Internet"
                  },
                  "destinationPortRanges": {
                    "value": [
                      443,
                      80
                    ]
                  },
                  "sourcePortRanges": {
                    "value": []
                  },
                  "direction": {
                    "value": "Outbound"
                  },
                  "destinationAddressPrefixes": {
                    "value": []
                  }
                },
                "template": {
                  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                  "contentVersion": "1.0.0.0",
                  "metadata": {
                    "_generator": {
                      "name": "bicep",
                      "version": "0.14.85.62628",
                      "templateHash": "17943624777475516433"
                    }
                  },
                  "parameters": {
                    "NsgName": {
                      "type": "string"
                    },
                    "RuleName": {
                      "type": "string"
                    },
                    "protocol": {
                      "type": "string"
                    },
                    "sourcePortRange": {
                      "type": "string"
                    },
                    "sourceAddressPrefix": {
                      "type": "string"
                    },
                    "destinationAddressPrefix": {
                      "type": "string"
                    },
                    "access": {
                      "type": "string"
                    },
                    "priority": {
                      "type": "int"
                    },
                    "direction": {
                      "type": "string"
                    },
                    "sourcePortRanges": {
                      "type": "array"
                    },
                    "destinationPortRanges": {
                      "type": "array"
                    },
                    "sourceAddressPrefixes": {
                      "type": "array"
                    },
                    "destinationAddressPrefixes": {
                      "type": "array"
                    }
                  },
                  "resources": [
                    {
                      "type": "Microsoft.Network/networkSecurityGroups/securityRules",
                      "apiVersion": "2021-08-01",
                      "name": "[format('{0}/{1}', parameters('NsgName'), parameters('RuleName'))]",
                      "properties": {
                        "protocol": "[parameters('protocol')]",
                        "sourcePortRange": "[parameters('sourcePortRange')]",
                        "sourceAddressPrefix": "[parameters('sourceAddressPrefix')]",
                        "destinationAddressPrefix": "[parameters('destinationAddressPrefix')]",
                        "access": "[parameters('access')]",
                        "priority": "[parameters('priority')]",
                        "direction": "[parameters('direction')]",
                        "sourcePortRanges": "[parameters('sourcePortRanges')]",
                        "destinationPortRanges": "[parameters('destinationPortRanges')]",
                        "sourceAddressPrefixes": "[parameters('sourceAddressPrefixes')]",
                        "destinationAddressPrefixes": "[parameters('destinationAddressPrefixes')]"
                      }
                    }
                  ]
                }
              },
              "dependsOn": [
                "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, parameters('OnPremRGname')), 'Microsoft.Resources/deployments', parameters('OnPremRGname'))]",
                "[subscriptionResourceId('Microsoft.Resources/resourceGroups', parameters('OnPremRGname'))]"
              ]
            }
          ],
          "outputs": {
            "OnPremVnetName": {
              "type": "string",
              "value": "[parameters('OnPremVnetName')]"
            },
            "NSGname": {
              "type": "string",
              "value": "[if(parameters('DeployNSG'), variables('networkSecurityGroupName'), '')]"
            },
            "PEsubnetName": {
              "type": "string",
              "value": "[variables('PEsubnetName')]"
            },
            "ProxyName": {
              "type": "string",
              "value": "[if(parameters('DeployProxy'), variables('Proxyname'), '')]"
            },
            "DMZsubnetName": {
              "type": "string",
              "value": "[variables('DMZsubnetName')]"
            }
          }
        }
      },
      "dependsOn": [
        "[extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('HubRgName')), 'Microsoft.Resources/deployments', format('HubEssentialDeploy-{0}', parameters('Seed')))]"
      ]
    }
  ],
  "outputs": {
    "HubRgName": {
      "type": "string",
      "value": "[variables('HubRgName')]"
    },
    "HubVNetName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('HubRgName')), 'Microsoft.Resources/deployments', format('HubEssentialDeploy-{0}', parameters('Seed'))), '2020-10-01').outputs.HubVnetName.value]"
    },
    "DnsIp": {
      "type": "string",
      "value": "[if(parameters('DeployDNS'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('HubRgName')), 'Microsoft.Resources/deployments', format('HubEssentialDeploy-{0}', parameters('Seed'))), '2020-10-01').outputs.DNSIp.value, '')]"
    },
    "FwName": {
      "type": "string",
      "value": "[if(parameters('DeployRT'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('HubRgName')), 'Microsoft.Resources/deployments', format('HubEssentialDeploy-{0}', parameters('Seed'))), '2020-10-01').outputs.FwName.value, '')]"
    },
    "RulesetName": {
      "type": "string",
      "value": "[if(parameters('DeployDNS'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('HubRgName')), 'Microsoft.Resources/deployments', format('HubEssentialDeploy-{0}', parameters('Seed'))), '2020-10-01').outputs.RulesetName.value, '')]"
    },
    "KvName": {
      "type": "string",
      "value": "[if(parameters('DeployKV'), reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('HubRgName')), 'Microsoft.Resources/deployments', format('HubEssentialDeploy-{0}', parameters('Seed'))), '2020-10-01').outputs.KvName.value, '')]"
    },
    "PEsubnetName": {
      "type": "string",
      "value": "[reference(extensionResourceId(format('/subscriptions/{0}/resourceGroups/{1}', subscription().subscriptionId, variables('HubRgName')), 'Microsoft.Resources/deployments', format('HubEssentialDeploy-{0}', parameters('Seed'))), '2020-10-01').outputs.PEsubnetName.value]"
    },
    "SpokeRGname": {
      "type": "string",
      "value": "[if(greater(parameters('SpokesNumber'), 0), variables('SpokeRgName'), '')]"
    },
    "SpokesVnetNames": {
      "type": "array",
      "value": "[if(greater(parameters('SpokesNumber'), 0), reference(subscriptionResourceId('Microsoft.Resources/deployments', format('SpokesDeploy-{0}', parameters('Seed'))), '2020-10-01').outputs.SpokesVnetName.value, createArray())]"
    },
    "OnPremRGname": {
      "type": "string",
      "value": "[if(parameters('DeployOnPrem'), variables('OnPremRGname'), '')]"
    },
    "OnpremVNetName": {
      "type": "string",
      "value": "[if(parameters('DeployOnPrem'), reference(subscriptionResourceId('Microsoft.Resources/deployments', format('OnPremDeploy-{0}', parameters('Seed'))), '2020-10-01').outputs.OnPremVnetName.value, '')]"
    },
    "ProxyName": {
      "type": "string",
      "value": "[if(parameters('DeployProxy'), reference(subscriptionResourceId('Microsoft.Resources/deployments', format('OnPremDeploy-{0}', parameters('Seed'))), '2020-10-01').outputs.ProxyName.value, '')]"
    },
    "DMZsubnetName": {
      "type": "string",
      "value": "[if(parameters('DeployOnPrem'), reference(subscriptionResourceId('Microsoft.Resources/deployments', format('OnPremDeploy-{0}', parameters('Seed'))), '2020-10-01').outputs.DMZsubnetName.value, '')]"
    }
  }
}